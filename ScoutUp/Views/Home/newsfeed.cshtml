@model ScoutUp.Models.User
@Html.Partial("~/Views/Shared/header.cshtml")
    <div id="page-contents">
    	<div class="container">
    		<div class="row">

         <!--Left Side-->
                @Html.Partial("~/Views/Shared/leftside.cshtml")

		        <!-- Post Create Box
		        ================================================= -->
		        @Html.Partial("~/Views/Shared/PostCreateBox.cshtml")
            <!-- Post Create Box End-->

            <!-- Post Content
            ================================================= -->
		        <div id ="posts">
		            @Html.Action("NewsFeedPosts","Post")
		        </div>
                </div>
          <!-- Right side-->
            @Html.Partial("~/Views/Shared/rightside.cshtml")
    		</div>
    	</div>
    </div>

   <!--Footer-->
    @Html.Partial("~/Views/Shared/footer.cshtml")
<script src="../../Scripts/jquery.signalR-2.2.3.js"></script>
<script src="../../Scripts/jquery.signalR-2.2.3.min.js"></script>
<script src="../../signalr/hubs"></script>
    <script type="text/javascript" src="../../js/right-side.js"></script>
<script>
    function refreshUsersFollowing() {
        var url = "@(Html.Raw(Url.Action("usersFollowers", "Home")))";
        $.get(url, function (e) {
            $("#follower-count").text(e + " Takipçi")
        });
        setInterval(function () {
            var url = "@(Html.Raw(Url.Action("usersFollowers", "Home")))";
            $.get(url, function (e) {
                $("#follower-count").text(e + " Takipçi")
            });
        }, 30000); ///Refreshes every 30 seconds

        $.ajaxSetup({ cache: false });  //Turn off caching
    }; refreshUsersFollowing();
</script>
<script>
    $(".form-control").keypress(function(e) {
        if (e.which == 13) {
            var self = $(this);
            var commen = self.val();
            var id = self.attr('data-id');
            var url = "/post/addcommenttopost";
            $.post(url,
                { postid: id, comment: commen },
                function(o) {
                    if (o == 1) {
                        var url = "/post/postcomments/"+id;
                        $("#yorum" + id).load(url);
                        self.val("");
                    } else {
                        alert("Yorumu gönderirken bir sorun oluştu.");
                    }
                });
        }
    });
    $("body").on('click',
        '.yorum',
        function (e) {
            e.preventDefault();
            var self = $(this);
            var id = self.attr("data-id");
            var x = $("#" + id);
            var commentCount = (x[0].children.length-1)/2;
            var url = "/post/postcomments/" + id +"/"+ (commentCount + 5);
            $("#" + id).load(url);
        });
</script>
<script>
    $('#userPost').submit(function (evt) {
        evt.preventDefault();
        var $file = document.getElementById('postImage'),
            $formData = new FormData();
        var text = $('#postText').val();
        $formData.append("postText", text);
        if ($file.files.length > 0) {
            for (var i = 0; i < $file.files.length; i++) {
                $formData.append('file-' + i, $file.files[i]);
            }
        }
        $.ajax({
            url: '/post/addpost',
            type: 'POST',
            data: $formData,
            datatype: "multipart/form-data",
            processData: false,
            contentType: false,
            complete: function(response) {
                if (response.responseJSON.success) {
                    $("#posts").load("@Html.Raw(Url.Action("Posts", "Post", new {userid = @Model.UserID}))");
                } else {
                    alert("Bir hata oluştu" + response["message"]);
                }
            },
            error: function($data) {
                alert("Bir hata oluştu" + $data["message"]);
            }
        });
    });
</script>
<script>
 $(function () {

     if ($(".btn").length > 0) {
         var postClient = $.connection.postHub;

         postClient.client.updateLikeCount = function (post) {
             var self = $("#" + post.PostId);
             self.html('<i class="icon ion-thumbsup"></i> Beğen ' + post.LikeCount);
         };

         $("body").on("click", ".btn", function () {
             var code = $(this).attr("id");
             var self = $(this);
             var clas = self.attr('class');
             var isLiked = clas.endsWith('text-red');
             if (isLiked) {
                 self.removeClass('text-red');
                 self.addClass('text-green');
             } else {
                 self.removeClass('text-green');
                 self.addClass('text-red');
             }
             postClient.server.like(code, @Model.UserID);
         });
     }
 });
</script>
<script>
    $(function () {

        // Reference the auto-generated proxy for the hub.

        var notification = $.connection.notificationHub;
        var newNotificitaionsToUpdate = [];
        // Client side method for receiving the list of notifications on the connected event from the server
        notification.client.refreshNotification = function (data) {
            for (var i = 0; i < data.length; i++) {
                $("#bildirim").append("<li><a href='"+data[i].NotificationLink +"'>" + data[i].UserNotificationsMessage + "</a></li>");
            }
            if(data.length> 0){
                 $("#bildirimler").html('Bildirimler '+ data.length +'<span><img src="../../images/down-arrow.png" alt="" /></span>');
            }
            $("body").on("click", ".dropdown-toggle", function () {
                var self = $(this);
                notification.server.updateNotification(data);
                $("#bildirimler").html('Bildirimler<span><img src="../../images/down-arrow.png" alt="" /></span>');
            });

        }

//Client side method which will be invoked from the Global.asax.cs file.
        notification.client.updateNotification = function (data) {
            $("#bildirim").append("<li><a href='"+data.NotificationLink +"'>" + data.UserNotificationsMessage + "</a></li>");
            newNotificitaionsToUpdate.push(data);
            $("#bildirimler").html('Bildirimler '+ newNotificitaionsToUpdate.length +'<span><img src="../../images/down-arrow.png" alt="" /></span>');
            $("body").on("click", ".dropdown-toggle", function () {
                var self = $(this);
                notification.server.updateNotification(newNotificitaionsToUpdate);
                newNotificitaionsToUpdate = [];
                $("#bildirimler").html('Bildirimler<span><img src="../../images/down-arrow.png" alt="" /></span>');
            });
        }

        // Start the connection.
        $.connection.hub.start().done(function () {

            //When the send button is clicked get the text and user name and send it to server.
            $("body").on("click", ".btn", function () {
                var self = $(this);
                var userid = self.attr("data-id");
                var postid = self.attr("id");
                var clas = self.attr('class');
                var isLiked = clas.endsWith('text-red');
                if (!isLiked) {
                    notification.server.sendNotification(userid," @Model.UserName"
                        + " " +" @Model.UserSurname" +" gönderini beğendi","",postid);
                }
            });

        });
    });
</script>
